# Deploy to Pivotal Cloud Foundry

## Docker

The first we need to do is to generate a docker image and push it to any registry.
We will use the [DockerHub](https://hub.docker.com) registry for the example.

> You can use any Docker Registry that you want, either DockerHub, any private Docker Registry or GCR. If you want more information of how to deploy from any of this registries you should check this [link](https://docs.cloudfoundry.org/devguide/deploy-apps/push-docker.html)

#### Docker Image Publish
There are three steps to publish a Docker Image to DockerHub:

1. Register to DockerHub [SignUp](https://hub.docker.com/register/)
2. Once we are logged in, we need to [create a repository](https://hub.docker.com/add/repository/) for each image (**Name** This is the name of the docker image, this is the identifier along with the account name)
3. Edit the `IMAGE` variable from `docker-release.sh` for each service with the new repository (<ACCOUNT_USERNAME>/<REPOSITORY_NAME>)

Now that we have all configured, we are ready to run `docker-release.sh`. Once it finish, the docker image is published to Docker Hub.

#### Docker Image Implementation

Simple Dockerfile extending from `maven` image. The build part of the image just install the dependencies and generates de package (jar file), the runtime of the Dockerfile runs the jar generated by the build.

## Pivotal CloudFoundry
Now that we have our images pushed to DockerHub, we can now focus on push them into Pivotal Platform.

The first requirement we have is to create an account in [Pivotal](https://pivotal.io/get-started).
When you get access to your console, you should create an organization manually. It's simple as fill an input inside *Create an Org*.

Next step is to install the CF CLI in our computer. You have a guide to do it in your platform in [PCF CLI Install](https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/install-the-cf-cli)

Once we have CF CLI installed in our machine, you can now login to your Pivotal account:

    $ cf login -a https://api.run.pivotal.io

Now you have connected your CF CLI with your account of Pivotal, you just need to go inside each service and run:

    $ cf push

Once we have both services deployed (`frontservice` and `backservice`) we need to do something more.

We need to create a policy to allow connections from `frontservice` to `backservice` using `tcp` protocol on port 8082 (the configured port inside `backservice`).
That is done running this command:

    $ cf add-network-policy frontservice --destination-app backservice --port 8082 --protocol tcp

## How does it work?

For each service we have created a `manifest.yml` with all the configuration needed to CF for deploy it correctly.

`Frontservice` knows about `backservice host`  from an environment variable set inside manifest.yml.
