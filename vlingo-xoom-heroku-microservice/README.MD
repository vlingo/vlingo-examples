# Xoom Microservice deploying on Heroku Example

In this example application, you'll be introduced to how implement a microservice with `vlingo-xoom-server` and `micronaut` deploying it on Heroku.

## Project Structure

The following tree structure is from the project's `./src/main/java` directory. Here we can see the domain model and the endpoint definition. 

`Calculation Microservice`

    .
    └── io
        └── examples
            ├── CalculationApplication.java
            └── calculation
                ├── application
                │   ├── CalculationApplicationService.java (Business Logic)
                │   └── ExecuteCalculation.java (Command)
                ├── domain
                │   ├── Calculation.java (Aggregate)
                │   └── Operation.java (Value Object)
                ├── repository
                │   ├── CalculationRepository.java 
                │   └── InMemoryCalculationRepository.java
                └── endpoint
                    ├── CalculationEndpoint.java (Anti-corruption Layer)
                    └── v1
                        └── CalculationResource.java


In addition to the tree structure above, you will find `./src/main/tests` for unit tests and `./src/main/java/resources/application.yml` for externalized configuration.

## Capabilities

This microservice example will demonstrate a basic set of capabilities for building cloud-native microservices. The `vlingo-xoom` project is meant to provide you with the simplest developer abstractions for building high-performance networked applications. For building microservices, we've decided to use the JVM microframework, Micronaut. 

### Micronaut

Micronaut is an opinionated JVM microframework that covers a set of capabilities that lend well to multiple application use cases. Micronaut is most popularly used for building microservices. Based on the conventions that were made popular by projects like Spring Boot, Micronaut was built from the ground up to allow native JVM compilation. Micronaut's major leap forward from Spring Boot is its emphasis on compile-time annotation processing instead of using runtime reflection.

In short, Micronaut provides feature parity with Spring Boot but does so at compile time instead of during runtime. Applications have a smaller footprint and can be compiled down into native images that do not need to use the JVM. See [GraalVM Native Image](https://www.graalvm.org/docs/why-graal/#for-microservices-frameworks), for more details.

#### Example Capabilities (Micronaut)

This microservice example demonstrates the following capabilities that are enabled by [Micronaut](http://micronaut.io).

- Dependency Injection and Compile-time Annotations
- Externalized Twelve-factor Configuration ([12factor.net](https://12factor.net/config))
- Repository-based Persistence with JPA/Hibernate
- Embedded Client-Server HTTP Framework with Vlingo Xoom Server
- Embedded In-Memory Database with H2
- Unit Testing with Micronaut's HTTP Client

### Vlingo Xoom
 
Vlingo provides a high-performance reactive toolkit for the JVM that is based on the actor model and Domain-Driven Design. Vlingo Xoom brings together the multiple core libraries contained in [vlingo/platform](https://docs.vlingo.io/) for different types of application use cases, such as building reactive microservices. Vlingo focuses on providing an application framework, toolkit, and methodology that enables teams to successfully practice and benefit from DDD.

#### Example Capabilities (Vlingo Xoom)

This microservice example demonstrates the following capabilities that are enabled by [vlingo/platform](http://docs.vlingo.io).

- Deployment on Heroku Cloud Platform 
- Reactive Client-Server Framework with [vlingo/http](https://docs.vlingo.io/vlingo-http)
- Domain-Driven Design (DDD)
  - Building an anti-corruption layer
  - Evolving and versioning a REST API
  - Using versioned endpoint definitions instead of MVC controllers

## Heroku Deployment

There are few steps to prepare a [vlingo/xoom](https://docs.vlingo.io/vlingo-xoom) app for a deployment on Heroku: 
-First, according to the Heroku [documentation](https://devcenter.heroku.com/articles/procfile), we need to add a Procfile in the app root folder containing command to execute the application jar

    java -jar target/heroku-microservice-0.1.jar

-Since this application was generated by the [Micronaut CLI](https://docs.micronaut.io/latest/guide/index.html#buildCLI), the Maven Shade Plugin is used, by default, to manipulate the jar building. In order to avoid the invalid signature exception while executing the jar, the following transformers must be added into the pom configuration, specifically in the maven shade plugin section:
    
    <transformer implementation="org.apache.maven.plugins.shade.resource.DontIncludeResourceTransformer">
      <resource>.SF</resource>
    </transformer>
    <transformer implementation="org.apache.maven.plugins.shade.resource.DontIncludeResourceTransformer">
      <resource>.DSA</resource>
    </transformer>
    <transformer implementation="org.apache.maven.plugins.shade.resource.DontIncludeResourceTransformer">
      <resource>.RSA</resource>
    </transformer> 

-Finally, after the previous steps, the application is ready to be deployed using the [Heroku CLI](https://devcenter.heroku.com/articles/git) or manually by adding the remote Heroku Git repository as follows:

    git remote add heroku https://heroku:[heroku-apy-key]@git.heroku.com/[heroku-app-name].git
    git push heroku [local-branch-name]:master   

### REST API

- `method=GET, uri=/v1/calculations, to=calculate(ExecuteCalculation executeCalculation)`
- `method=GET, uri=/v1/calculations/operations, to=retrieveSupportedOperations()`

## Running the Example

To compile this example, clone this repository and execute the following command in your terminal.

    $ ./mvn clean package

After you successfully compile the application, execute the next command to run the microservice.

    $ ./java -jar target/heroku-microservice-0.1.jar

If everything was a success, you should see the following terminal output.

    2019-11-06 09:46:43 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
    2019-11-06 09:46:43 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
    2019-11-06 09:46:43 [main] INFO  org.hibernate.Version - HHH000412: Hibernate Core {5.4.7.Final}
    2019-11-06 09:46:43 [main] INFO  o.h.annotations.common.Version - HCANN000001: Hibernate Commons Annotations {5.1.0.Final}
    2019-11-06 09:46:43 [main] INFO  org.hibernate.dialect.Dialect - HHH000400: Using dialect: org.hibernate.dialect.H2Dialect
    2019-11-06 09:46:44 [main] INFO  io.vlingo.VlingoScene - New scene created: __defaultStage
    2019-11-06 09:46:44 [pool-3-thread-4] INFO  i.v.a.Logger - ServerRequestResponseChannelActor: OPENING PORT: 8080
    2019-11-06 09:46:44 [pool-3-thread-3] INFO  i.v.a.Logger - Server vlingo-http-server is listening on port: 8080 started in 47 ms
    2019-11-06 09:46:44 [pool-3-thread-3] INFO  i.v.a.Logger - Resource: Account Endpoint Resource v1.1
    2019-11-06 09:46:44 [pool-3-thread-3] INFO  i.v.a.Logger - Action: id=0, method=GET, uri=/v1/accounts/{id}, to=dynamic1(Long id)
    2019-11-06 09:46:44 [pool-3-thread-3] INFO  i.v.a.Logger - Action: id=1, method=PUT, uri=/v1/accounts/{id}, to=dynamic2(Long id)
    2019-11-06 09:46:44 [pool-3-thread-3] INFO  i.v.a.Logger - Action: id=2, method=DELETE, uri=/v1/accounts/{id}, to=dynamic3(Long id)
    2019-11-06 09:46:44 [pool-3-thread-3] INFO  i.v.a.Logger - Action: id=3, method=GET, uri=/v1/accounts, to=dynamic4()
    2019-11-06 09:46:44 [pool-3-thread-3] INFO  i.v.a.Logger - Action: id=4, method=POST, uri=/v1/accounts, to=dynamic5()
    2019-11-06 09:46:44 [main] INFO  io.vlingo.VlingoServer - 
                ░▒░▒░      _ _                    
                ░▒░▒░     | (_)                   
     ▒░▒░▒   ░▒░▒░  __   _| |_ _ __   __ _  ___   
     ▒░▒░▒   ░▒░▒░  \ \ / / | | '_ \ / _` |/ _ \
         ▒░▒░▒       \ V /| | | | | | (_| | (_) |
         ░▒░▒░        \_/ |_|_|_| |_|\__, |\___/
                                      __/ | Xoom v0.1.0
                                     |___/
    2019-11-06 09:46:44 [main] INFO  io.vlingo.VlingoServer - Started embedded Vlingo Xoom server at http://localhost:8080
    2019-11-06 09:46:44 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 1846ms. Server Running: http://localhost:8080
 
## Client Usage Examples
 
Now that the server is running, you can execute the following `curl` commands to interact with the `Calculation` REST API.
 
### Perform Operation

Execute the following command to get an result from the `Calculation` operation.

    curl -X POST http://localhost:8080/v1/calculations" -H "Content-Type: application/json" -d \
    '{
       "operationName": "addition",
       "fisrtOperand": "3",
       "secondOperand": "2"
     }' -i

### Retrieve Supported Operations

Execute the following command to get all `Operation`.

    curl -X GET -H "Content-Type: application/json" http://localhost:8080/v1/calculations/operations -i 